define(["jquery","jqueryui","core/log","filter_poodll/utils_amd","filter_poodll/poodll_mediarecorder"],function(a,b,c,d,e){"use strict";return c.debug("Test controller: initialising"),{currentitemid:0,currentitem:0,itemcount:null,cmid:null,testdata:null,holderid:null,recorderid:null,playerid:null,startbuttonid:null,controls:null,fbrecorder:null,clone:function(){return a.extend(!0,{},this)},init:function(b){var d=this.clone(),e="#amdopts_"+b.widgetid,f=a(e).get(0);return f?(d.testdata=JSON.parse(f.value),a(e).remove(),d.cmid=b.cmid,d.holderid=b.widgetid+"_holder",d.recorderid=b.widgetid+"_recorder",d.playerid=b.widgetid+"_player",d.startbuttonid=b.widgetid+"_startbutton",d.itemcount=d.testdata.length,d.setup_recorder(),d.process_html(),void d.register_events()):void c.debug("FB Test Controller: No config found on page. Giving up.")},start_item:function(){var a=this;a.currentitem=a.currentitem+1,a.currentitem>a.itemcount;var b=a.testdata[a.currentitem-1];a.currentitemid=b.itemid,a.controls.progress.text(b.itemprogress),a.controls.header.text(b.itemheader),a.controls.othertext.html(b.itemtext);var c=a.fbrecorder.fetch_instanceprops();c.config.timelimit=b.timetarget,c.config.resource=b.resourceurl,c.config.resource2=b.modelurl;var d=c.controlbar;d.resourcebutton.click()},process_html:function(){var b={holder:a("#"+this.holderid),the_dialog:a("#"+this.holderid+"  .mod_fluencybuilder_dialogcontentbox"),me_play:a("#"+this.holderid+"  .mod_fluencybuilder_me_play"),me_ok:a("#"+this.holderid+"  .mod_fluencybuilder_me_ok"),me_ng:a("#"+this.holderid+"  .mod_fluencybuilder_me_ng"),player:a("#"+this.playerid),startbutton:a("#"+this.startbuttonid),progress:a("#"+this.holderid+"  .mod_fluencybuilder_itemprogress"),header:a("#"+this.holderid+"  .mod_fluencybuilder_itemheader"),othertext:a("#"+this.holderid+"  .mod_fluencybuilder_itemothertext")};this.controls=b},warmup_player:function(){var a=this.controls.player[0];try{a.play(),a.pause()}catch(b){}},setup_recorder:function(){var a=[],b=M.cfg.wwwroot+"/filter/poodll/ding.mp3";a.widgetid=this.recorderid,a.media_timeinterval=2e3,a.media_audiomimetype="audio/webm",a.media_videorecordertype="auto",a.media_videocapturewidth=320,a.media_videocaptureheight=240,a.mediatype="audio",a.media_skin="fluencybuilder",a.media_skin_style="",a.timelimit=5,a.hideupload=!0,a.resource=b,a.resource2=b;var c=e.embed("#"+this.recorderid,a);this.fbrecorder=c},register_events:function(){var b=this,c=b.fbrecorder.fetch_instanceprops();b.controls.me_ok.click(function(){b.send_evaluation("ok")}),b.controls.me_ng.click(function(){b.send_evaluation("ng")}),b.controls.startbutton.click(function(){a(this).hide(),b.warmup_player(),b.controls.holder.show(),b.start_item()}),b.controls.startbutton.removeClass("mod_fluencybuilder_startbutton_disabled"),b.controls.me_play.click(function(){var a=b.controls.player[0];e.do_play_audio(c,a)});var d=function(){var c=M.util.get_string("recui_next","mod_fluencybuilder"),d={};d[c]=function(){b.currentitem==b.itemcount?(window.location.replace(M.cfg.wwwroot+"/mod/fluencybuilder/view.php?id="+b.cmid),a(this).dialog("close")):(a(this).dialog("close"),b.start_item())},b.controls.the_dialog.dialog({dialogClass:"mod_fluencybuilder_no-close",resizable:!1,height:"auto",width:400,modal:!0,buttons:d})},f=c.controlbar.modelplayer;if(f.length<1)var g=setInterval(function(){var c=a("#"+b.holderid+"  .poodll_modelplayer_fluencybuilder");c.length>0&&(clearInterval(g),c.on("ended",d))},500);else f.on("ended",d)},send_evaluation:function(a){var b=new XMLHttpRequest,d=this;b.onreadystatechange=function(a){if(4===this.readyState)if(200==b.status){c.debug("ok we got an attempt update response");var d=b.responseText,e=JSON.parse(d);if(e)switch(e.message){case"noted":c.debug("attempted item evaluation accepted"),e.attemptid!=window.attemptid&&(window.attemptid=e.attemptid);break;case"problem":default:c.debug("attempted item evaluation failure")}}else c.debug("Not 200 response:"+b.status)};var e=0;window.attemptid&&(e=window.attemptid);var f="itemid="+d.currentitemid+"&cmid="+d.cmid+"&eval="+a+"&attemptid="+e;b.open("POST",M.cfg.wwwroot+"/mod/fluencybuilder/jsonresults.php",!0),b.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),b.setRequestHeader("Cache-Control","no-cache"),b.send(f)}}});